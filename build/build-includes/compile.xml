<?xml version="1.0"?>
<project name="compile" basedir="." default="local-run">

	<target name="clean-bin">
		<!-- Remove all directories created during the build process -->
		<if>
			<available type="dir" file="${bin.loc}" />
			<then>
				<delete includeemptydirs="true" failonerror="false">
					<fileset dir="${bin.loc}" defaultexcludes="false">
						<include name="**/*" />
					</fileset>
				</delete>
			</then>
			<else>
				<mkdir dir="${bin.loc}" />
			</else>
		</if>
	</target>


	<target name="setup-bin" depends="clean-bin">
		<sync todir="${bin.loc}">
			<fileset dir="${basedir}/build/bin-resources" />
		</sync>

		<copy file="${basedir}/build/html-template/index.template.html" tofile="${bin.loc}/index.html" />

		<replace file="${bin.loc}/index.html" propertyFile="${basedir}/build/html-template/html.properties">
			<replacefilter token="@width@" property="width" />
			<replacefilter token="@height@" property="height" />
			<replacefilter token="@example@" value="${project.name.versioned}" />
			<replacefilter token="@version_major@" property="version_major" />
			<replacefilter token="@version_minor@" property="version_minor" />
			<replacefilter token="@version_minor@" property="version_minor" />
			<replacefilter token="@version_revision@" property="version_revision" />
		</replace>
	</target>
	
	<!-- Compile Release SWF -->
	<target name="compile-swf" depends="setup-bin">
		<echo>[compile] Compiling SWF</echo>
		<echo>[compile] Using Flex SDK at: ${FLEX_HOME}</echo>

		<java jar="${FLEX_HOME}/lib/mxmlc.jar" dir="${FLEX_HOME}/frameworks" fork="true" failonerror="true">
			<arg value="${main.src.loc}/${project.name}.as" />
			<arg value="-source-path=${main.src.loc}" />

			<arg value="-output=${bin.loc}/swfs/${project.name.versioned}.swf" />
			<arg value="-static-link-runtime-shared-libraries=true" />
			<!-- Include classes from SWCs in this folder, but only the ones we use. -->
			<arg value="-library-path+=${lib.loc}" />

			<arg value="-incremental=true" />
			<arg value="-debug=true" />
			<arg value="-verbose-stacktraces=true" />
			<arg value="-headless-server=true" />
		</java>

		<echo>[compile] Debug SWF ${project.name.versioned}.swf created successfully</echo>
	</target>

	<target name="local-run" depends="compile-swf">
		<exec executable="${browser}">
			<arg line="file://${bin.loc}/index.html" />
		</exec>
	</target>

	<!-- Compile Release SWC -->
	<target name="compile-swc">
		<echo>[compile] Compiling release SWC</echo>
		<echo>[compile] Using Flex SDK at: ${FLEX_HOME}</echo>

		<java jar="${FLEX_HOME}/lib/compc.jar" dir="${FLEX_HOME}/frameworks" fork="true" failonerror="true">
			<!-- Build our SWC with a versioned name. -->
			<arg value="-output=${bin.loc}/${project.name.versioned}.swc" />

			<!-- We want all the org package classes in the SWC being built. -->
			<arg value="-include-sources=${main.src.loc}/" />

			<!-- Include classes from SWCs in this folder, but only the ones we use. -->
			<arg value="-library-path+=${lib.loc}" />

			<!-- Keep the magic alive. -->
			<arg value="-keep-as3-metadata+=Inject" />

			<!-- Boolean mosh pit! -->
			<arg value="-incremental=true" />
			<arg value="-static-link-runtime-shared-libraries=true" />
			<arg value="-verbose-stacktraces=true" />
			<arg value="-headless-server=true" />
		</java>

		<echo>[compile] Release SWC ${project.name.versioned}.swc created successfully</echo>
	</target>

</project>
